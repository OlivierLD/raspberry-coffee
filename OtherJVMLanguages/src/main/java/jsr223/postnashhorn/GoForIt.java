package jsr223.postnashhorn;

import com.fasterxml.jackson.databind.ObjectMapper;

import javax.script.*;
import java.io.IOException;
import java.util.List;
import java.util.Map;

/**
 * ES 6.
 * Create a function, then invoke it.
 */
public class GoForIt {

    private final static String SOME_JSON = "{\"formattedProblems\":\"- Error: Cannot convert ABC to Number, [input entry[2,5]]\\n- Warning: Expected number for condition <ABC, [input entry[2,5]]\\n\\n[First], Expense.Approver, Expense.Approvee, Expense.Employee Level, Expense.Remaining Budget, Expense.Amount, Expense.Type, Manager Justified, Strategy, Reason\\n1, johnny.gau@oracle.com, sam.thorpe@acme.com, -, -, {\\\"operation1\\\":\\\"<\\\",\\\"endpoint1\\\":\\\"120\\\"}, -, -, Approve, set my auto approval limit for Sam to $120\\n2, alex.smith@acme.com, sam.thorpe@acme.com, -, -, {\\\"operation1\\\":\\\"<\\\",\\\"endpoint1\\\":\\\"ABC\\\"}, -, -, Approve, set my auto approval limit for sam to ABC\\n3, alex.smith@acme.com, -, -, -, {\\\"operation1\\\":\\\"<\\\",\\\"endpoint1\\\":\\\"100\\\"}, -, -, Approve, sure, set my auto approval limit to $100\\n4, ernie.johnson@acme.com, -, -, -, {\\\"operation1\\\":\\\"<\\\",\\\"endpoint1\\\":\\\"2000\\\"}, -, -, Review, Ernie has recently had some expenses questioned\\n5, -, -, -, -, -, -, -, Review, No applicable manager preference\",\"hitPolicy\":\"First\",\"upsertType\":\"update\",\"newDecisionTableRules\":[{\"Expense.Approver\":\"johnny.gau@oracle.com\",\"Expense.Remaining Budget\":\"-\",\"Expense.Approvee\":\"sam.thorpe@acme.com\",\"Manager Justified\":\"-\",\"Expense.Amount\":{\"endpoint1\":\"120\",\"operation1\":\"<\"},\"Strategy\":\"Approve\",\"Expense.Type\":\"-\",\"Reason\":\"set my auto approval limit for Sam to $120\",\"Expense.Employee Level\":\"-\"},{\"Expense.Approver\":\"alex.smith@acme.com\",\"Expense.Remaining Budget\":\"-\",\"Expense.Approvee\":\"sam.thorpe@acme.com\",\"Manager Justified\":\"-\",\"Expense.Amount\":{\"endpoint1\":\"ABC\",\"operation1\":\"<\"},\"Strategy\":\"Approve\",\"Expense.Type\":\"-\",\"Reason\":\"set my auto approval limit for sam to ABC\",\"Expense.Employee Level\":\"-\"},{\"Expense.Approver\":\"alex.smith@acme.com\",\"Expense.Remaining Budget\":\"-\",\"Expense.Approvee\":\"-\",\"Manager Justified\":\"-\",\"Expense.Amount\":{\"endpoint1\":\"100\",\"operation1\":\"<\"},\"Strategy\":\"Approve\",\"Expense.Type\":\"-\",\"Reason\":\"sure, set my auto approval limit to $100\",\"Expense.Employee Level\":\"-\"},{\"Expense.Approver\":\"ernie.johnson@acme.com\",\"Expense.Remaining Budget\":\"-\",\"Expense.Approvee\":\"-\",\"Manager Justified\":\"-\",\"Expense.Amount\":{\"endpoint1\":\"2000\",\"operation1\":\"<\"},\"Strategy\":\"Review\",\"Expense.Type\":\"-\",\"Reason\":\"Ernie has recently had some expenses questioned\",\"Expense.Employee Level\":\"-\"},{\"Expense.Approver\":\"-\",\"Expense.Remaining Budget\":\"-\",\"Expense.Approvee\":\"-\",\"Manager Justified\":\"-\",\"Expense.Amount\":\"-\",\"Strategy\":\"Review\",\"Expense.Type\":\"-\",\"Reason\":\"No applicable manager preference\",\"Expense.Employee Level\":\"-\"}],\"originalRulesValues\":[{\"outputEntries\":[{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Advanced\"],\"@class\":\".Builder\",\"role\":\"Rule Output\",\"suggestions\":[{\"mode\":\"Text\",\"value\":\"Reject\"},{\"mode\":\"Text\",\"value\":\"Review\"},{\"mode\":\"Text\",\"value\":\"Approve\"}],\"suggest\":true,\"value\":\"Approve\"},{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Advanced\"],\"@class\":\".Builder\",\"role\":\"Rule Output\",\"suggest\":true,\"value\":\"set my auto approval limit for Sam to $120\"}],\"annotationEntries\":[\"\",\"\"],\"inputEntries\":[{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"johnny.gau@oracle.com\"},{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"sam.thorpe@acme.com\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Number\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"range\":{\"endpoint1\":\"120\",\"operation1\":\"<\"},\"suggest\":true},{\"mode\":\"Any\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggestions\":[{\"mode\":\"Text\",\"value\":\"Travel\"},{\"mode\":\"Text\",\"value\":\"Procurement\"},{\"mode\":\"Text\",\"value\":\"Onboarding\"}],\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"True or False\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"}]},{\"outputEntries\":[{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Advanced\"],\"@class\":\".Builder\",\"role\":\"Rule Output\",\"suggestions\":[{\"mode\":\"Text\",\"value\":\"Reject\"},{\"mode\":\"Text\",\"value\":\"Review\"},{\"mode\":\"Text\",\"value\":\"Approve\"}],\"suggest\":true,\"value\":\"Approve\"},{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Advanced\"],\"@class\":\".Builder\",\"role\":\"Rule Output\",\"suggest\":true,\"value\":\"set my auto approval limit for sam to ABC\"}],\"annotationEntries\":[\"\",\"\"],\"inputEntries\":[{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"alex.smith@acme.com\"},{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"sam.thorpe@acme.com\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Number\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"range\":{\"endpoint1\":\"ABC\",\"operation1\":\"<\"},\"suggest\":true,\"problems\":[{\"severity\":\"Error\",\"message\":\"Cannot convert ABC to Number\"},{\"severity\":\"Warning\",\"message\":\"Expected number for condition <ABC\"}]},{\"mode\":\"Any\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggestions\":[{\"mode\":\"Text\",\"value\":\"Travel\"},{\"mode\":\"Text\",\"value\":\"Procurement\"},{\"mode\":\"Text\",\"value\":\"Onboarding\"}],\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"True or False\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"}]},{\"outputEntries\":[{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Advanced\"],\"@class\":\".Builder\",\"role\":\"Rule Output\",\"suggestions\":[{\"mode\":\"Text\",\"value\":\"Reject\"},{\"mode\":\"Text\",\"value\":\"Review\"},{\"mode\":\"Text\",\"value\":\"Approve\"}],\"suggest\":true,\"value\":\"Approve\"},{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Advanced\"],\"@class\":\".Builder\",\"role\":\"Rule Output\",\"suggest\":true,\"value\":\"sure, set my auto approval limit to $100\"}],\"annotationEntries\":[\"\",\"\"],\"inputEntries\":[{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"alex.smith@acme.com\"},{\"mode\":\"Any\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Number\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"range\":{\"endpoint1\":\"100\",\"operation1\":\"<\"},\"suggest\":true},{\"mode\":\"Any\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggestions\":[{\"mode\":\"Text\",\"value\":\"Travel\"},{\"mode\":\"Text\",\"value\":\"Procurement\"},{\"mode\":\"Text\",\"value\":\"Onboarding\"}],\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"True or False\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"}]},{\"outputEntries\":[{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Advanced\"],\"@class\":\".Builder\",\"role\":\"Rule Output\",\"suggestions\":[{\"mode\":\"Text\",\"value\":\"Reject\"},{\"mode\":\"Text\",\"value\":\"Review\"},{\"mode\":\"Text\",\"value\":\"Approve\"}],\"suggest\":true,\"value\":\"Review\"},{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Advanced\"],\"@class\":\".Builder\",\"role\":\"Rule Output\",\"suggest\":true,\"value\":\"Ernie has recently had some expenses questioned\"}],\"annotationEntries\":[\"\",\"\"],\"inputEntries\":[{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"ernie.johnson@acme.com\"},{\"mode\":\"Any\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Number\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"range\":{\"endpoint1\":\"2000\",\"operation1\":\"<\"},\"suggest\":true},{\"mode\":\"Any\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggestions\":[{\"mode\":\"Text\",\"value\":\"Travel\"},{\"mode\":\"Text\",\"value\":\"Procurement\"},{\"mode\":\"Text\",\"value\":\"Onboarding\"}],\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"True or False\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"}]},{\"outputEntries\":[{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Advanced\"],\"@class\":\".Builder\",\"role\":\"Rule Output\",\"suggestions\":[{\"mode\":\"Text\",\"value\":\"Reject\"},{\"mode\":\"Text\",\"value\":\"Review\"},{\"mode\":\"Text\",\"value\":\"Approve\"}],\"suggest\":true,\"value\":\"Review\"},{\"mode\":\"Text\",\"allowedModes\":[\"Text\",\"Advanced\"],\"@class\":\".Builder\",\"role\":\"Rule Output\",\"suggest\":true,\"value\":\"No applicable manager preference\"}],\"annotationEntries\":[\"\",\"\"],\"inputEntries\":[{\"mode\":\"Any\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Number\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"Text\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggestions\":[{\"mode\":\"Text\",\"value\":\"Travel\"},{\"mode\":\"Text\",\"value\":\"Procurement\"},{\"mode\":\"Text\",\"value\":\"Onboarding\"}],\"suggest\":true,\"value\":\"-\"},{\"mode\":\"Any\",\"allowedModes\":[\"True or False\",\"Any\",\"Advanced\"],\"not\":false,\"@class\":\".Builder\",\"role\":\"Rule Test\",\"suggest\":true,\"value\":\"-\"}]}],\"originalUtterance\":\"set my auto approval limit for sam to ABC\",\"problems\":[{\"severity\":\"Error\",\"path\":[\"input entry[2,5]\"],\"message\":\"Cannot convert ABC to Number\"},{\"severity\":\"Warning\",\"path\":[\"input entry[2,5]\"],\"message\":\"Expected number for condition <ABC\"}]}";

    // Executing JS Code on a JSON Object
    public static void main(String... arg) throws ScriptException, NoSuchMethodException, IOException {

        final List<ScriptEngineFactory> engineFactories = new ScriptEngineManager().getEngineFactories();
        System.out.printf("Found %d engine factory(ies)\n", engineFactories.size());
        engineFactories.forEach(ef -> System.out.printf("Engine %s, Language %s, LngVersion %s, EngVersion %s, aka [%s]\n", ef.getEngineName(), ef.getLanguageName(), ef.getLanguageVersion(), ef.getEngineVersion(), String.join(", ", ef.getNames())));

//        System.setProperty("polyglot.js.nashorn-compat", "true");

        String jsScript =
                "let extract = data => {" +
                "  print('From JS - Orig Data:' + data);" +
                "  let extracted = JSON.parse(data).problems;" +
                "  print('From JS - Extracted:' + JSON.stringify(extracted));" +
                "  // Compose message array\n" +
                "  let messArray = [];" +
                "  extracted.forEach(mess => {" +
                "    messArray.push(mess.severity + ' - ' + mess.message);" +
                "  });" +
                "  // return extracted;\n" +
                "  // return JSON.stringify(extracted);\n" +
                "  return JSON.stringify(messArray);" +
                "};";

        ScriptEngine graalEngine = new ScriptEngineManager().getEngineByName("graal.js");

        // Start here.
        System.out.println(jsScript);
        graalEngine.eval(jsScript);

        Invocable invocable = (Invocable) graalEngine;
        Object result = invocable.invokeFunction("extract", SOME_JSON);
        System.out.println("From Java:" + result);
        System.out.println("Got a " + result.getClass().getName());

        if (result instanceof List<?>) {
            System.out.println("Ah!");
        } else if (result instanceof Map<?, ?>) {
            Map<?, ?> map = (Map<?, ?>)result;
            map.keySet().forEach(k -> {
                Object obj = map.get(k);
                System.out.println(obj);
            });
        } else {
            ObjectMapper mapper = new ObjectMapper();
            Object obj = mapper.readValue(result.toString(), Object.class);
            System.out.println("Returned a " + obj.getClass().getName());
            if (obj instanceof List<?>) {
                List<?> list = (List<?>)obj;
                list.forEach(elem -> System.out.printf("-- (%s) %s\n", elem.getClass().getName(), elem));
            }
        }

        System.out.println("Done!");
    }
}
