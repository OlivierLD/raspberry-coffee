<!DOCTYPE html>
<!--
 | QS Parameters:
 |     interval=5000   in ms, default 5000
 |     test=true|false default false
 +-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AIS with Leaflet</title>
    <link rel="icon" type="image/jpg" href="../icons/jellyfish.ico">
    <style type="text/css">
        * {
            font-family: "Source Code Pro", "Courier New", "Helvetica Neue", "Lato", Verdana, Helvetica, Geneva, sans-serif;
            color: navy;
        }
        h1 {
            font-size: x-large;
            font-weight: bold;
        }
        td, th {
            border: 1px solid silver;
            border-radius: 5px;
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

</head>
<body>
<h1>AIS plotter</h1>
<hr/>
<table>
    <tr>
        <td valign="top">
            <!--div id="mapid" style="width: 1200px; height: 800px;"></div-->
            <div id="mapid" style="width: 1200px; height: 600px; resize: both; overflow: auto;"></div>
        </td>
        <td valign="top" align="left" style="padding: 5px;">
            <input type="checkbox" id="keep-centered" checked/><small>Keep map centered</small>
            <hr/>
            <i><b>Mouse position:</b></i>
            <hr/>
            <small><i>Degrees, Decimal mins:</i></small>
            <div id="curr-pos"></div>
            <hr/>
            <small><i>Decimal:</i></small>
            <div id="curr-pos-dec"></div>
            <hr/>
            <i><b>Last click position:</b></i>
            <hr/>
            <small><i>Degrees, Decimal mins:</i></small>
            <div id="curr-pos-click"></div>
            <hr/>
            <small><i>Decimal:</i></small>
            <div id="curr-pos-click-dec"></div>
            <hr/>
            <span id="ais-status"></span>
        </td>
    </tr>
</table>
<hr/>
<span style="font-style: italic;">&copy 2020, Oliv did it.</span>

</body>

<script type="text/javascript">

    if (Math.toRadians == undefined) {
        Math.toRadians = deg => {
            return (deg / 180) * Math.PI;
        };
    }

    function getQSPrm(prm) {
        let loc = document.location.toString();
        if (loc.indexOf("?") > -1) {
            let qs = loc.substring(loc.indexOf("?") + 1);
            let prms = qs.split('&');
            for (let i=0; i<prms.length; i++) {
                let nv = prms[i].split('=');
                if (nv.length === 2) {
                    if (nv[0] === prm) {
                        return nv[1];
                    }
                }
            }
        }
        return null;
    }

    let options = {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    };

    let userPos = {
        lat: 37.75,
        lng: -122.5
    }; // Default. Will get this from NMEA Pos

    function decToSex(val, ns_ew) {
        let absVal = Math.abs(val);
        let intValue = Math.floor(absVal);
        let dec = absVal - intValue;
        let i = intValue;
        dec *= 60;
        let s = i + "°" + dec.toFixed(2) + "'";

        if (val < 0) {
            s += (ns_ew === 'NS' ? 'S' : 'W');
        } else {
            s += (ns_ew === 'NS' ? 'N' : 'E');
        }
        return s;
    }

    let map = L.map('mapid'); // .setView([currentLatitude, currentLongitude], 13);

/*  L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 28,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(map); */

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    map.fitBounds([
        [40.712, -74.227],
        [40.774, -74.125]
    ]);

    let currentBound = [];
    let mapMarkers = [];

    map.addEventListener('mousemove', (event) => {
        // let lat = Math.round(event.latlng.lat * 100000) / 100000;
        // let lng = Math.round(event.latlng.lng * 100000) / 100000;
        let lat = event.latlng.lat;
        let lng = event.latlng.lng;
        while (lng > 180) {
            lng -= 360;
        }
        while (lng < -180) {
            lng += 360;
        }
        document.getElementById('curr-pos').innerHTML = `${decToSex(lat, "NS")}<br/>${decToSex(lng, "EW")}`;
        document.getElementById('curr-pos-dec').innerHTML = `${lat}<br/>${lng}`;
    });
    map.addEventListener('click', (event) => {
        // let lat = Math.round(event.latlng.lat * 100000) / 100000;
        // let lng = Math.round(event.latlng.lng * 100000) / 100000;
        let lat = event.latlng.lat;
        let lng = event.latlng.lng;
        while (lng > 180) {
            lng -= 360;
        }
        while (lng < -180) {
            lng += 360;
        }
        document.getElementById('curr-pos-click').innerHTML = `${decToSex(lat, "NS")}<br/>${decToSex(lng, "EW")}`;
        document.getElementById('curr-pos-click-dec').innerHTML = `${lat}<br/>${lng}`;
    });

    function getTimeExtrema(ais) {
        let mini = Number.MAX_VALUE;
        let maxi = -Number.MAX_VALUE;
        let keys = Object.keys(ais); // MMSIs
        for (let i=0; i<keys.length; i++) { // MMSI
            let aisRecord = ais[keys[i]];
            let aisKeys = Object.keys(aisRecord);
            for (let j=0; j<aisKeys.length; j++) { // Record types
                let aisKey = aisKeys[j];
                let timestamp = aisRecord[aisKey].recordTimeStamp;
                if (timestamp !== undefined) {
                    mini = Math.min(mini, timestamp);
                    maxi = Math.max(maxi, timestamp);
                }
            }
        }
        return {mini: mini, maxi: maxi};
    }

    let onMessage = json => {
        currentBound = []; // Reset
        if (userPos !== null) {
            currentBound.push([userPos.lat, userPos.lng]);
            // Remove all markers from the map
            mapMarkers.forEach(mark => {
               map.removeLayer(mark);
            });

            if (json["Position"] !== undefined) {
                userPos.lat = json["Position"].lat;
                userPos.lng = json["Position"].lng;
            }
            let marker =  L.marker([userPos.lat, userPos.lng]);
            mapMarkers.push(marker);
            marker.addTo(map)
                .bindPopup(`<b>You are here<br/><span style="color: red;">${decToSex(userPos.lat, "NS")}<br/>${decToSex(userPos.lng, "EW")}</span></b>`);
        }
        if (json.ais !== null && json.ais !== undefined) {
            let ais = json.ais; // Full AIS object
            let minMax = getTimeExtrema(ais);

            let keys = Object.keys(ais);
            document.getElementById("ais-status").innerHTML =
                `<small>At ${new Date()}</small>` +
                `<br/>${keys.length} AIS record(s)` +
                `<br/><small><i><b>Between</b></i><br/>${new Date(minMax.mini)}<br/>` +
                `<i><b>and</b></i><br/>${new Date(minMax.maxi)}</small>`;
            for (let i=0; i<keys.length; i++) { // MMSI
                let k = keys[i];
                let aisRecord = ais[k];
                let MMSI = k;
                let aisKeys = Object.keys(aisRecord);
                for (let j=0; j<aisKeys.length; j++) { // Record types
                    let aisKey = aisKeys[j];
                    // console.log("Key:" + aisKey);
                    let recordType = aisRecord[aisKey].messageType; // Same as str(aisKey)
                    let recordDescription = aisRecord[aisKey].messageDescription;
                    let navStatus = null;
                    let vesselName = null;
                    let vesselType = null;
                    if (recordType === 1 || recordType === 2 || recordType === 3) {
                      navStatus = aisRecord[aisKey].navStatusDesc;
                      let voyageRelatedData = aisRecord["5"];
                      if (voyageRelatedData !== undefined) {
                          vesselName = voyageRelatedData.vesselNameStr;
                          vesselType = voyageRelatedData.shipTypeStr;
                      }
                    }

                    let aidType = (recordType === 21 ? aisRecord[aisKey].aidTypeDesc : null);
                    let oneRecord = aisRecord[aisKey].recordContent;
                    let isBoat = false; // Should be types 1, 2, or 3
                    if (oneRecord !== undefined) {
                        // console.log(`AIS for MMSI ${MMSI}, type ${recordType}`);
                        if (oneRecord.latitude !== null && oneRecord.latitude !== undefined &&
                            oneRecord.longitude !== null && oneRecord.longitude !== undefined) {
                            // console.log(`MMSI: ${MMSI}\nRecord Type ${recordType}\nAt ${oneRecord.latitude} / ${oneRecord.longitude}`);
                            if (oneRecord.longitude < 180 && oneRecord.longitude > -180) {
                                // Put in array for Leaflet
                                currentBound.push([oneRecord.latitude, oneRecord.longitude]);
                                if (oneRecord.hdg !== undefined && oneRecord.cog !== undefined && oneRecord.sog !== undefined) {
                                    isBoat = true;
                                }
                                // console.log(`MMSI: ${MMSI}\nRecord Type ${recordType}\nAt ${oneRecord.latitude} / ${oneRecord.longitude}, boat:${isBoat}`);
                                if (isBoat) { // It's a boat
                                    // HDG=511 => n/a
                                    // Draw a boat, use oneRecord.hdg, oneRecord.cog
                                    let boatLen = 0.02;
                                    let hdg = oneRecord.hdg;
                                    let cog = oneRecord.cog;
                                    if (hdg === 511) {
                                        hdg = cog;
                                        cog = null;
                                    }
                                    // Yellow arrow
                                    let boatTriangle = L.polygon([ // HDG
                                        [oneRecord.latitude + ((boatLen / 2) * Math.cos(Math.toRadians(hdg))),
                                            oneRecord.longitude + ((boatLen / 2) * Math.sin(Math.toRadians(hdg)))],           // Bow
                                        [oneRecord.latitude - ((boatLen / 2) * Math.cos(Math.toRadians(hdg - 10))),
                                            oneRecord.longitude - ((boatLen / 2) * Math.sin(Math.toRadians(hdg - 10)))],
                                        [oneRecord.latitude - ((boatLen * 0.9 / 2) * Math.cos(Math.toRadians(hdg - 0))),
                                            oneRecord.longitude - ((boatLen * 0.9 / 2) * Math.sin(Math.toRadians(hdg - 0)))], // Transom center
                                        [oneRecord.latitude - ((boatLen / 2) * Math.cos(Math.toRadians(hdg + 10))),
                                            oneRecord.longitude - ((boatLen / 2) * Math.sin(Math.toRadians(hdg + 10)))]
                                    ], {
                                        color: 'yellow',
                                        fillColor: '#ff3',
                                        fillOpacity: 0.5
                                    });
                                    mapMarkers.push(boatTriangle);
                                    boatTriangle.addTo(map);

                                    if (cog !== null) {
                                        // Blue line
                                        let boatCog = L.polyline([ // COG
                                            [oneRecord.latitude + ((boatLen * 1.1 / 2) * Math.cos(Math.toRadians(cog))),
                                                oneRecord.longitude + ((boatLen * 1.1 / 2) * Math.sin(Math.toRadians(cog)))], // Bow
                                            [oneRecord.latitude - ((boatLen * 1.1 / 2) * Math.cos(Math.toRadians(cog))),
                                                oneRecord.longitude - ((boatLen * 1.1 / 2) * Math.sin(Math.toRadians(cog)))]
                                        ], {
                                            color: 'blue'
                                        });
                                        mapMarkers.push(boatCog);
                                        boatCog.addTo(map);
                                    }

                                    let boatSpot = L.circle([oneRecord.latitude, oneRecord.longitude], {
                                        color: 'red',
                                        fillColor: '#f03',
                                        fillOpacity: 0.5,
                                        radius: 500
                                    });
                                    mapMarkers.push(boatSpot);
                                    boatSpot.addTo(map);
                                }
                                // Popup
                                let marker = L.marker([oneRecord.latitude, oneRecord.longitude]);
                                mapMarkers.push(marker);
                                let popupText = `<small>Rec.#${i}/${j}, ${recordDescription !== null ? recordDescription : 'Type ' + recordType}</small><br/>` +
                                    `<b>MMSI ${MMSI}<br/><span style="color: red;">${decToSex(oneRecord.latitude, "NS")}<br/>` +
                                    `${decToSex(oneRecord.longitude, "EW")}</span></b>${aidType !== null ? '<br/>' + aidType : ''}`;
                                if (isBoat) {
                                    popupText += `<br/>SOG: ${oneRecord.sog}<br/>COG: ${oneRecord.cog}<br/>HDG: ${oneRecord.hdg === 511 ? 'n/a' : oneRecord.hdg}<br/>${navStatus !== undefined && navStatus !== null ? navStatus : ''}`;
                                    if ((vesselType !== null && vesselType !== undefined) || (vesselName !== null && vesselName !== undefined)) {
                                        popupText += "<br/>";
                                    }
                                    if (vesselType !== null && vesselType !== undefined) {
                                        popupText += `${vesselType} `;
                                    }
                                    if (vesselName !== null && vesselName !== undefined) {
                                        popupText += `"${vesselName.trim()}"`;
                                    }
                                }
                                marker.addTo(map)
                                    .bindPopup(popupText);
                            } else {
                                console.log(`Longitude Problem: MMSI: ${MMSI}\nRecord Type ${recordType}\nAt ${oneRecord.latitude} / ${oneRecord.longitude}`);
                            }
                        }
                    }
                }
            }
            if (currentBound.length > 0) {
                let centerCB = document.getElementById('keep-centered');
                if (centerCB.checked) {
                    map.fitBounds(currentBound);
                }
            }
        } else {
            // console.info("No AIS");
            document.getElementById("ais-status").innerHTML = "No AIS";
            map.panTo(new L.LatLng(userPos.lat, userPos.lng));
        }
    };

    function getNMEAData() {

        let url = /*'http://192.168.42.6:9999' + */ '/mux/cache',
            // xhr = new XMLHttpRequest(),
            verb = 'GET',
            TIMEOUT = 10000,
            happyCode = 200,
            data = null;

        let promise = new Promise(function (resolve, reject) {
            let xhr = new XMLHttpRequest();
            // let req = verb + " " + url;
            // if (data !== undefined && data !== null) {
            //     req += ("\n" + JSON.stringify(data, null, 2));
            // }
            xhr.open(verb, url, true);
            xhr.setRequestHeader("Content-type", "application/json");
            try {
                if (data === undefined || data === null) {
                    xhr.send();
                } else {
                    xhr.send(JSON.stringify(data));
                }
            } catch (err) {
                console.log("Send Error ", err);
            }

            let requestTimer = setTimeout(() => {
                xhr.abort();
                let mess = {code: 408, message: 'Timeout'};
                reject(mess);
            }, TIMEOUT);

            xhr.onload = () => {
                clearTimeout(requestTimer);
                if (xhr.status === happyCode) {
                    resolve(xhr.response);
                } else {
                    reject({code: xhr.status, message: xhr.response});
                }
            };
        });
        return promise;
    }

    function fetch() {
        let getData = getNMEAData();
        getData.then((value) => {
            //  console.log("Done:", value);
            let json = JSON.parse(value);
            onMessage(json);
        }, (error, errmess) => {
            let message;
            if (errmess !== undefined) {
                try {
                    let mess = JSON.parse(errmess);
                    if (mess.message !== undefined) {
                        message = mess.message;
                    }
                } catch (err) {
                    //  console.log(errmess);
                }
            }
            console.log("Failed to get nmea data..." + (error !== undefined ? JSON.stringify(error) : ' - ') + ', ' + (message !== undefined ? message : ' - '));
        });

    }

    let betweenPing = 5000;
    let interval = getQSPrm("interval");
    if (interval !== null) {
        betweenPing = parseInt(interval);
    }

    let FOR_TEST = (getQSPrm("test") === 'true');

    if (!FOR_TEST) {
        (() => {
            fetch();
            // Long poll for NMEA/AIS
            setInterval(() => {
                fetch();
            }, betweenPing);
        })();
    } else {
        // For tests
        let json = {
            "Damping": 1,
            "NMEA_AS_IS": {
                "GGA": "$GNGGA,191542.00,3744.93640,N,12230.42279,W,1,06,2.19,-11.2,M,-29.9,M,,*62\r",
                "TXT": "$GNTXT,01,01,02,PF=3FF*4B\r",
                "GSA": "$GNGSA,A,3,81,,,,,,,,,,,,3.64,2.19,2.91*14\r",
                "GLL": "$GNGLL,3744.93640,N,12230.42279,W,191542.00,A,A*6B\r",
                "VTG": "$GNVTG,,T,,M,0.188,N,0.349,K,A*32\r",
                "RMC": "$GNRMC,191542.00,A,3744.93640,N,12230.42279,W,0.188,,280920,,,A*72\r",
                "GSV": [
                    "$GLGSV,2,1,08,66,02,037,11,67,52,028,11,68,69,240,,69,17,222,*68",
                    "$GLGSV,2,2,08,81,11,140,21,82,60,128,17,83,63,342,,84,07,325,*67"
                ],
                "AIS": "!AIVDM,1,1,,B,403Ovk1vBNC?Do>jO8EdjGO026Ht,0*34"
            },
            "HDG Offset": 0.0,
            "Delta Altitude": 76.2,
            "ais": {
                "993692026": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692026,
                        "recordTimeStamp": 1601319816621,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Beacon, Special mark",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.798183,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 19,
                            "Dim2Port": 0,
                            "longitude": -122.37784
                        }
                    }
                },
                "993692027": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692027,
                        "recordTimeStamp": 1601317535615,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Beacon, Special mark",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.800785,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 19,
                            "Dim2Port": 0,
                            "longitude": -122.37504
                        }
                    }
                },
                "993692024": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692024,
                        "recordTimeStamp": 1601316315668,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Beacon, Special mark",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.790745,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 19,
                            "Dim2Port": 0,
                            "longitude": -122.3858
                        }
                    }
                },
                "993692344": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692344,
                        "recordTimeStamp": 1601316103634,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Light, no sector",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.815586,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 5,
                            "Dim2Port": 0,
                            "longitude": -122.52952
                        }
                    }
                },
                "993692028": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692028,
                        "recordTimeStamp": 1601317539612,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Beacon, Special mark",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.80562,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 19,
                            "Dim2Port": 0,
                            "longitude": -122.369865
                        }
                    }
                },
                "993692018": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 0,
                        "MMSI": 993692018,
                        "recordTimeStamp": 1601316883634,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Reference point",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.5,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 1,
                            "Dim2Port": 0,
                            "longitude": -122.72721
                        }
                    }
                },
                "993692019": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692019,
                        "recordTimeStamp": 1601319162749,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Reference point",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.65445,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 1,
                            "Dim2Port": 0,
                            "longitude": -122.72721
                        }
                    }
                },
                "993692016": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692016,
                        "recordTimeStamp": 1601319591631,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Reference point",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.705833,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 1,
                            "Dim2Port": 0,
                            "longitude": -122.80445
                        }
                    }
                },
                "993692278": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692278,
                        "recordTimeStamp": 1601318623620,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Starboard hand Mark",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.763332,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 25,
                            "Dim2Port": 0,
                            "longitude": -122.62903
                        }
                    }
                },
                "993692009": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692009,
                        "recordTimeStamp": 1601316771626,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Reference point",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.65305,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 1,
                            "Dim2Port": 0,
                            "longitude": -122.66312
                        }
                    }
                },
                "993692014": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692014,
                        "recordTimeStamp": 1601318220214,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Reference point",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.815,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 1,
                            "Dim2Port": 0,
                            "longitude": -122.78695
                        }
                    }
                },
                "993692013": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 0,
                        "MMSI": 993692013,
                        "recordTimeStamp": 1601319367640,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Beacon, Safe water",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.98055,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 18,
                            "Dim2Port": 0,
                            "longitude": -123.15139
                        }
                    }
                },
                "993692001": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692001,
                        "recordTimeStamp": 1601317295621,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Beacon, Safe water",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.74993,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 18,
                            "Dim2Port": 0,
                            "longitude": -122.69276
                        }
                    }
                },
                "993692006": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692006,
                        "recordTimeStamp": 1601318875626,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Reference point",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.678883,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 1,
                            "Dim2Port": 0,
                            "longitude": -122.77972
                        }
                    }
                },
                "993692007": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 0,
                        "MMSI": 993692007,
                        "recordTimeStamp": 1601318255134,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Beacon, Safe water",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.53945,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 18,
                            "Dim2Port": 0,
                            "longitude": -123.04639
                        }
                    }
                },
                "993692005": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 0,
                        "MMSI": 993692005,
                        "recordTimeStamp": 1601319747624,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Beacon, Safe water",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 38.124718,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 18,
                            "Dim2Port": 0,
                            "longitude": -123.35972
                        }
                    }
                },
                "368084240": {
                    "3": {
                        "messageType": 3,
                        "repeatIndicator": 0,
                        "MMSI": 368084240,
                        "recordTimeStamp": 1601320178459,
                        "messageDescription": "Position Report (A)",
                        "navStatusDesc": "Under way using engine",
                        "recordContent": {
                            "utc": 37,
                            "rot": -127,
                            "latitude": 37.785652,
                            "NavStatus": 0,
                            "PosAcc": 1,
                            "sog": 8.3,
                            "cog": 64.4,
                            "hdg": 64,
                            "longitude": -122.54868
                        }
                    },
                    "5": {
                        "messageType": 5,
                        "repeatIndicator": 0,
                        "MMSI": 368084240,
                        "recordTimeStamp": 1601319961694,
                        "messageDescription": "Voyage Related Data",
                        "vesselNameStr": "SEA HAWK            ",
                        "shipTypeStr": "Tug",
                        "recordContent": {
                            "AisVersion": 2,
                            "ImoNumber": 7729526,
                            "Destination": "US^0V7R>05YG        ",
                            "EtaDay": 0,
                            "Dim2Stbd": 5,
                            "Dim2Bow": 15,
                            "Draught": 51,
                            "VesselName": "SEA HAWK            ",
                            "Dim2Port": 5,
                            "EtaHour": 24,
                            "EtaMinute": 60,
                            "CallSign": "WDK7414",
                            "EtaMonth": 0,
                            "Dim2Stern": 19,
                            "ShipType": 52
                        }
                    }
                },
                "371885000": {
                    "1": {
                        "messageType": 1,
                        "repeatIndicator": 0,
                        "MMSI": 371885000,
                        "recordTimeStamp": 1601320061312,
                        "messageDescription": "Position Report (A)",
                        "navStatusDesc": "Under way using engine",
                        "recordContent": {
                            "utc": 39,
                            "rot": 0,
                            "latitude": 38.289066,
                            "NavStatus": 0,
                            "PosAcc": 0,
                            "sog": 9.1,
                            "cog": 142.0,
                            "hdg": 143,
                            "longitude": -123.509895
                        }
                    }
                },
                "3669145": {
                    "4": {
                        "messageType": 4,
                        "repeatIndicator": 0,
                        "MMSI": 3669145,
                        "recordTimeStamp": 1601319481816,
                        "messageDescription": "Base Station",
                        "recordContent": {
                            "UtcYear": 2020,
                            "UtcHour": 18,
                            "UtcMinute": 58,
                            "UtcSecond": 1,
                            "latitude": 37.794308,
                            "PosAcc": 1,
                            "UtcMonth": 9,
                            "UtDay": 28,
                            "longitude": -122.4648
                        }
                    }
                },
                "3669709": {
                    "4": {
                        "messageType": 4,
                        "repeatIndicator": 0,
                        "MMSI": 3669709,
                        "recordTimeStamp": 1601317480759,
                        "messageDescription": "Base Station",
                        "recordContent": {
                            "UtcYear": 2020,
                            "UtcHour": 18,
                            "UtcMinute": 24,
                            "UtcSecond": 40,
                            "latitude": 37.82039,
                            "PosAcc": 1,
                            "UtcMonth": 9,
                            "UtDay": 28,
                            "longitude": -122.53075
                        }
                    }
                },
                "3669708": {
                    "4": {
                        "messageType": 4,
                        "repeatIndicator": 0,
                        "MMSI": 3669708,
                        "recordTimeStamp": 1601320520437,
                        "messageDescription": "Base Station",
                        "recordContent": {
                            "UtcYear": 2020,
                            "UtcHour": 19,
                            "UtcMinute": 15,
                            "UtcSecond": 20,
                            "latitude": 37.92314,
                            "PosAcc": 1,
                            "UtcMonth": 9,
                            "UtDay": 28,
                            "longitude": -122.59845
                        }
                    },
                    "20": {
                        "messageType": 20,
                        "repeatIndicator": 0,
                        "MMSI": 3669708,
                        "recordTimeStamp": 1601320380345,
                        "messageDescription": "Data Link Mgmt",
                        "recordContent": {
                            "offset3": 0,
                            "increment1": 225,
                            "timeout3": 7,
                            "increment2": 750,
                            "timeout1": 7,
                            "offset2": 6,
                            "offset1": 100,
                            "timeout2": 7,
                            "increment3": 750
                        }
                    },
                    "15": {
                        "messageType": 15,
                        "repeatIndicator": 0,
                        "MMSI": 3669708,
                        "recordTimeStamp": 1601320268901,
                        "messageDescription": "Interrogation",
                        "recordContent": {
                            "InterrogatedMMSI": 338232047,
                            "FirstMessageType": 5,
                            "FirstSlotOffset": 0
                        }
                    }
                },
                "993692039": {
                    "21": {
                        "messageType": 21,
                        "repeatIndicator": 1,
                        "MMSI": 993692039,
                        "recordTimeStamp": 1601319099622,
                        "messageDescription": "Aid to Navigation",
                        "aidTypeDesc": "Light, no sector",
                        "recordContent": {
                            "utc": 61,
                            "latitude": 37.79282,
                            "PosAcc": 0,
                            "Dim2Stbd": 0,
                            "Dim2Bow": 0,
                            "Dim2Stern": 0,
                            "AidType": 5,
                            "Dim2Port": 0,
                            "longitude": -122.510376
                        }
                    }
                }
            },
            "Max Leeway": 0.0,
            "COG": {
                "angle": 0.0
            },
            "AWA Offset": 0.0,
            "RMCStatus": true,
            "Current calculated with damping": {},
            "Position": {
                "lat": 37.748940000000005,
                "lng": -122.5070465,
                "gridSquare": "CM87rr"
            },
            "Solar Time": {
                "date": "Sep 28, 2020, 4:15:11 AM",
                "fmtDate": {
                    "epoch": 1601291711568,
                    "year": 2020,
                    "month": 9,
                    "day": 28,
                    "hour": 11,
                    "min": 15,
                    "sec": 11
                }
            },
            "Default Declination": {
                "angle": 0.0
            },
            "SOG": {
                "speed": 0.188
            },
            "Deviation file name": "zero-deviation.csv",
            "GPS Date & Time": {
                "date": "Sep 28, 2020, 12:15:42 PM",
                "epoch": 1601320542000,
                "fmtDate": {
                    "epoch": 1601320542000,
                    "year": 2020,
                    "month": 9,
                    "day": 28,
                    "hour": 19,
                    "min": 15,
                    "sec": 42
                }
            },
            "BSP Factor": 1.0,
            "GPS Time": {
                "date": "Sep 28, 2020, 12:15:42 PM",
                "fmtDate": {
                    "epoch": 1601320542000,
                    "year": 2020,
                    "month": 9,
                    "day": 28,
                    "hour": 19,
                    "min": 15,
                    "sec": 42
                }
            },
            "AWS Factor": 1.0,
            "Satellites in view": {
                "81": {
                    "svID": 81,
                    "elevation": 11,
                    "azimuth": 140,
                    "snr": 21
                },
                "66": {
                    "svID": 66,
                    "elevation": 2,
                    "azimuth": 37,
                    "snr": 11
                },
                "82": {
                    "svID": 82,
                    "elevation": 60,
                    "azimuth": 128,
                    "snr": 17
                },
                "67": {
                    "svID": 67,
                    "elevation": 52,
                    "azimuth": 28,
                    "snr": 11
                },
                "83": {
                    "svID": 83,
                    "elevation": 63,
                    "azimuth": 342,
                    "snr": 0
                },
                "68": {
                    "svID": 68,
                    "elevation": 69,
                    "azimuth": 240,
                    "snr": 0
                },
                "84": {
                    "svID": 84,
                    "elevation": 7,
                    "azimuth": 325,
                    "snr": 0
                },
                "69": {
                    "svID": 69,
                    "elevation": 17,
                    "azimuth": 222,
                    "snr": 0
                }
            },
            "Small Distance": 13844.33813884775,
            "NMEA": "$GNGLL,3744.93640,N,12230.42279,W,191542.00,A,A*6B\r",
            "Altitude": -11.2
        };
        onMessage(json);
    }
</script>
</html>
