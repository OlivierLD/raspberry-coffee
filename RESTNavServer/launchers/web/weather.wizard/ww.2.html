<!DOCTYPE html>
<!--
 | Weather Wizard main features.
 | TODO Move to ES6, no JQuery...
 +-->
<html>
<head>
    <!--meta charset="windows-1252"-->
    <!--meta charset="iso-8859-1"-->
    <!--meta charset="utf-8"-->
    <meta http-equiv="Content-Type" content="text/html;charset=ISO-8859-1">
    <title>Weather Wizard</title>

    <link rel="icon" type="image/ico" href="../icons/hammerhead.02.ico">

    <link rel="stylesheet" href="../css/stylesheet.css" type="text/css"/>
    <link rel="stylesheet" href="../css/white.css" type="text/css" id="theme"/>
    <link rel="stylesheet" href="../css/worldmap.02.css" type="text/css"/>
    <link rel="stylesheet" href="../css/composites.css" type="text/css"/>

    <script type="text/javascript" src="../js/jquery-2.1.3.js"></script>
    <script type="text/javascript" src="../widgets/WorldMapData.js"></script>
    <script type="text/javascript" src="../js/mercator.utils.js"></script>
    <script type="text/javascript" src="../widgets/worldmap.js"></script>
    <script type="text/javascript" src="../js/conversion.utils.js"></script>
    <script type="text/javascript" src="../js/date.proto.js"></script>
    <script type="text/javascript" src="../js/routes.utils.js"></script>
    <script type="text/javascript" src="../js/grib.routing.js"></script>
    <script type="text/javascript" src="../catalog/catalog.js"></script> <!-- Composites catalog -->
    <script type="text/javascript" src="../js/ww.js"></script>

    <!-- Minimized versions, generated by ../gradlew minifyJS and ../gradlew minifyWidgets -->
    <!--script type="text/javascript" src="../minjs/jquery-2.1.3.js"></script>
    <script type="text/javascript" src="../minjs/WorldMapData.js"></script>
    <script type="text/javascript" src="../minjs/mercator.utils.js"></script>
    <script type="text/javascript" src="../minjs/worldmap.js"></script>
    <script type="text/javascript" src="../minjs/conversion.utils.js"></script>
    <script type="text/javascript" src="../minjs/date.proto.js"></script>
    <script type="text/javascript" src="../minjs/routes.utils.js"></script>
    <script type="text/javascript" src="../minjs/grib.routing.js"></script>
    <script type="text/javascript" src="../catalog/catalog.js"></script>
    <script type="text/javascript" src="../minjs/ww.js"></script-->

    <script type="text/javascript">

        var flavor = 'Ajax'; // Default, WebSocket not implemented here (we run on a small http server).

        var currentFax = 1;
        var canvas, context;

        var thisZoomFactor = 1;

        function messageManager(mess) {
            let messZone = document.getElementById("message-zone");
            if (messZone !== undefined && messZone !== null) {
                let existingContent = messZone.innerText;
                if (existingContent.trim().length > 0) {
                    existingContent += "\n";
                }
                existingContent += (typeof(mess) === 'object' ? JSON.stringify(mess) : mess);
                messZone.innerText = existingContent;
            } else {
                console.log(mess);
            }
        }

        function clearMessZone() {
            let messZone = document.getElementById("message-zone");
            messZone.innerText = '';
        }

        window.onload = function () {
            init(); // init UI

            canvas = document.getElementById('mapCanvas');
            context = canvas.getContext('2d');

            worldMap.clear();
            worldMap.setMouseMoveCallback(mouseMoveCallback);
            worldMap.setMouseClickCallback(mouseClickCallback);
            worldMap.setPositionLabel("Pos");
            setTimeout(function () {
                worldMap.drawWorldMap();
            }, 1);

            document.getElementById("console-type").innerHTML = 'The HTML5 ' + flavor + ' Console.';

            $("#map-container").height(window.innerHeight * 0.80);

            // Populate composites list
            for (var i = 0; i < compositeCatalog.length; i++) {
                var opt = document.createElement('option');
                opt.setAttribute('value', compositeCatalog[i].key);
                opt.appendChild(document.createTextNode(compositeCatalog[i].name));
                document.getElementById('composites').appendChild(opt);
                if (i === 0) {
                    if (compositeCatalog[i].gribRequest !== undefined) {
                        $("#grib-request").val(compositeCatalog[i].gribRequest);
                    }
                }
            }
        };

        var mouseClickCallback = function (obj) {
            messageManager("Mouse clicked on the Map.");
            // console.log("Mouse clicked on the map", obj);
            let lat = obj.lat;
            let lng = obj.lng;
            if (document.getElementById('rb-going-to').checked) {
                document.getElementById('routing-pos-lat-sign-01').value = (lat < 0 ? "S" : "N");
                document.getElementById('routing-pos-lng-sign-01').value = (lng < 0 ? "W" : "E");
                lat = Math.abs(lat);
                lng = Math.abs(lng);
                document.getElementById('routing-pos-lat-deg-01').value = Math.floor(lat).toFixed(0);
                document.getElementById('routing-pos-lng-deg-01').value = Math.floor(lng).toFixed(0);

                document.getElementById('routing-pos-lat-min-01').value = ((lat - Math.floor(lat)) * 60).toFixed(2);
                document.getElementById('routing-pos-lng-min-01').value = ((lng - Math.floor(lng)) * 60).toFixed(2);
            } else {
                position.lat = obj.lat;
                position.lng = obj.lng;
                worldMap.setUserPosition({latitude: position.lat, longitude: position.lng});
                redraw();
            }
        };

        var mouseMoveCallback = function (obj) {
            //  Display position, GRIB Data, etc...
            var mouseDataElmt = $("#mouse-data");
            var str = "Mouse X: " + obj.x + ", Y:" + obj.y;
            str += ("\nL: " + decToSex(obj.lat, "NS"));
            str += ("\nG: " + decToSex(obj.lng, "EW"));

            if (gribData !== undefined) {
                var date = $("#grib-dates").val();
                var oneDateGRIB = gribData[0]; // Default
                // Look for the right date
                for (var i = 0; i < gribData.length; i++) {
                    if (gribData[i].gribDate.formattedUTCDate === date) {
                        oneDateGRIB = gribData[i];
                        break;
                    }
                }
                // The current frame is oneDateGRIB
                // Find the GRIB Cell
                var xCell = oneDateGRIB.gribDate.width - 1,
                    yCell = oneDateGRIB.gribDate.height - 1;

                // console.log("  > xCell %d", xCell);

                for (var hGRIB = 0; hGRIB < oneDateGRIB.gribDate.height; hGRIB++) {
                    var lat = oneDateGRIB.gribDate.bottom + ((oneDateGRIB.gribDate.stepy * hGRIB));
                    if (lat > obj.lat) {
                        yCell = (hGRIB - 1);
                        break;
                    }
                }

                for (var wGRIB = 0; wGRIB < oneDateGRIB.gribDate.width; wGRIB++) {
                    var lng = ajustedLongitude(oneDateGRIB.gribDate.left, (oneDateGRIB.gribDate.stepx * wGRIB));
                    if (lng > 0 && obj.lng > 0 && lng > obj.lng) {
                        xCell = wGRIB - 1;
                        break;
                    } else if (lng < 0 && obj.lng < 0 && obj.lng < lng) {
                        xCell = wGRIB - 1;
                        break;
                    }
                }
                // console.log("  >> %s / %s is in cell Row:%d, Col:%d (Total is %d rows, %d cols)",
                // 		decToSex(obj.lat, "NS"),
                // 		decToSex(obj.lng, "EW"),
                // 		yCell,
                // 		xCell,
                // 		oneDateGRIB.gribDate.height,
                // 		oneDateGRIB.gribDate.width);

                str += ("\nGRIB cell row <b>" + yCell + "</b>, col <b>" + xCell + "</b>");
                var foundWind = false;
                for (var idx = 0; idx < oneDateGRIB.typedData.length; idx++) {
                    var skip = false;
                    if (oneDateGRIB.typedData[idx].data[yCell] === undefined) {
                        console.debug(">>>> oneDateGRIB.typedData[idx].data, yCell:%d, undefined.", yCell);
                        break;
                    }
                    var value = oneDateGRIB.typedData[idx].data[yCell][xCell];
                    var unit = oneDateGRIB.typedData[idx].gribType.unit;
                    var type = oneDateGRIB.typedData[idx].gribType.type;

                    // console.log("  >>> Type: %s, xCell: %d", type, xCell);

                    var displayValue, displayUnit, displayType;
                    switch (type) {
                        case 'prmsl':
                            displayType = 'PRMSL';
                            displayValue = (value / 100).toFixed(2);
                            displayUnit = 'hPa';
                            break;
                        case 'tmp':
                            displayType = 'AIRTMP';
                            displayValue = (value - 273.6).toFixed(2);
                            displayUnit = 'C';
                            break;
                        case 'ugrd':
                            if (!foundWind) {
                                var vgrd;
                                for (var i = 0; i < oneDateGRIB.typedData.length; i++) {
                                    if (oneDateGRIB.typedData[i].gribType.type === 'vgrd') {
                                        vgrd = oneDateGRIB.typedData[i].data;
                                        break;
                                    }
                                }
                                if (vgrd !== undefined) {
                                    displayUnit = '';
                                    displayType = "WIND";
                                    var u = value;
                                    var v = vgrd[yCell][xCell];
                                    var tws = getSpeed(u, v);
                                    var dir = getDir(u, v);
                                    displayValue = tws.toFixed(1) + " kts, " + dir.toFixed(0) + "&deg; (u:" + u.toFixed(1) + ", v:" + v.toFixed(1) + "), Cell <b>" + yCell + "</b>, <b>" + xCell + "</b>.";
                                    // console.log('w:%d, h:%d', yCell, xCell);
                                    foundWind = true;
                                }
                            } else {
                                skip = true;
                            }
                            break;
                        case 'vgrd':
                            skip = true;
                            break;
                        case 'prate':
                            displayType = 'PRATE';
                            displayValue = (value * 3600).toFixed(2);
                            displayUnit = "mm/h";
                            break;
                        case 'hgt':
                            displayType = '500HGT';
                            try {
                                displayValue = (value).toFixed(2);
                                displayUnit = "m";
                            } catch (err) {
                                displayValue = "xx";
                                displayUnit = "-";
                                // console.log(err);
                                messageManager(typeof(err) === 'object' ? JSON.stringify(err) : err);
                            }
                            break;
                        case 'htsgw':
                            displayType = 'WAVES';
                            if (oneDateGRIB.typedData[idx].data[0].length !== oneDateGRIB.gribDate.width) {
                                // Re-adjust. Waves do not have the same grid size...
                                let _xCell = Math.floor(xCell * oneDateGRIB.typedData[idx].data[0].length / oneDateGRIB.gribDate.width);
                                value = oneDateGRIB.typedData[idx].data[yCell][_xCell];
                            }
                            try {
                                displayValue = value.toFixed(2);
                                displayUnit = unit;
                            } catch (err) {
                                displayValue = "xx";
                                displayUnit = "-";
                                // console.log(err);
                                messageManager(typeof(err) === 'object' ? JSON.stringify(err) : err);
                            }
                            break;
                        default:
                            break;
                    }
                    if (!skip) {
                        str += ("\n" + displayType + ": " + displayValue + " " + displayUnit);
                    }
                }
            }
            mouseDataElmt.html("<pre>" + str + "</pre>");
        };

        var displayErr = function (err) {
            if (err !== undefined) {
                document.getElementById("err-mess").innerHTML = ("<small>" + err + "</small>");
            }
        };

        var withChart = true;

        var changeChart = function (cb) {
            withChart = cb.checked;
            redraw();
        };

        var changeGrid = function (cb) {
            worldMap.setWithGrid(cb.checked);
            redraw();
        };

        var changeTropics = function (cb) {
            worldMap.setWithTropics(cb.checked);
            redraw();
        };

        var changeGRIB = function (cb) {
            worldMap.setAfterDrawing(cb.checked ? renderGRIBData : undefined);
            redraw();
        };

        // changeFAXES
        var changeFAXES = function (cb) {
            // worldMap.setAfterDrawing(cb.checked ? renderGRIBData : undefined);
            for (let sh = 0; sh < show.length; sh++) {
                if (cb.checked === false) {
                  show[sh] = false;
                } else { // See the status of the corresponding Fax CB
                  show[sh] = cb.checked;
                  // Check all the checkboxes in table with id 'fax-table'
                  var faxTable = document.getElementById('fax-table');
                  let cbs = faxTable.querySelectorAll('input[type=checkbox]');
                  if (cbs !== undefined && cbs !== null) {
                     show[sh] = cbs[sh].checked;
                  }
                }
            }
            redraw();
        };

        var show = []; // [true, true, true];
        var faxName = [];
        // For 3 faxes Sfc, 500mb, StreamLines
        var zoom = []; // [0.3418498710866215, 0.5209310701416114, 1.0040821009550305];
        var topLeft = [];
        //  [
        //	  [10, 10],
        //	  [15, 30],
        //	  [-41, 460]
        //  ];
        var faxObj = [];

        var faxRequestCallback = function (val, originalRequest) {
            var returned = JSON.parse(val);

            // get data from originalRequest
            show = [];
            zoom = [];
            topLeft = [];
            faxObj = [];
            faxName = [];
            for (var idx = 0; idx < originalRequest.faxData.length; idx++) {
                show.push(true);

                var fax = new Image();
                var x = originalRequest.faxData[idx].location.x;
                var y = originalRequest.faxData[idx].location.y;
                var faxZoom = originalRequest.faxData[idx].zoom;
                zoom.push(faxZoom);
                topLeft.push([x, y]);
                faxName.push(originalRequest.faxData[idx].name);
                fax.onload = function () {
                    context.drawImage(fax, x, y, (parseInt(fax.width) * faxZoom), (parseInt(fax.height) * faxZoom));
                    redraw();
                };
                // Assume that returned and originalRequest have the same cardinality
                if (returned[idx].returned !== undefined) {
                    if (returned[idx].returned.startsWith("file:")) { // && returned[idx].returned.indexOf("/web/") > -1) {
                        // TODO Something better, relative to /web
                        var loc = returned[idx].returned.substring(returned[idx].returned.indexOf("/web/") + 1);
                        fax.src = '../../' + loc;
                    } else {
                        fax.src = '../../' + returned[idx].returned;
                    }
                }
                speakUp(idx + 1);
                // console.log(fax.src);
                messageManager(fax.src);
                faxObj.push(fax);
            }
        };

        var findCompositeByKey = function (key) {
            var comp = {};
            for (var i = 0; i < compositeCatalog.length; i++) {
                if (key === compositeCatalog[i].key) {
                    comp = compositeCatalog[i];
                    break;
                }
            }
            return comp;
        };

        var monthNames = [
            "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
        ];

        /*
         * Reload an existing composite.
         */
        var reload = function (key, compositeData) {
            console.log("Reloading", key, compositeData);
            var composite = findCompositeByKey(key);
            // Fill out with actual file locations
            if (composite.faxData !== undefined) {
                for (var i = 0; i < composite.faxData.length; i++) {
                    for (var f = 0; f < compositeData.length; f++) {
                        if (compositeData[f].type === 'FAX' &&
                            compositeData[f].name === '_' + key + '_' + i + '.png') {
                            composite.faxData[i].faxUrl = compositeData[f].resource;
                            break;
                        }
                    }
                }
                // GRIB
                if (composite.gribRequest !== undefined) {
                    for (var f = 0; f < compositeData.length; f++) {
                        if (compositeData[f].type === 'GRIB') { // name='grib.grb'
                            composite.gribRequest = compositeData[f].resource;
                            break;
                        }
                    }
                }
            }
            loadComposite(composite);
        };

        var getKeyFromName = function (name) {
            var key = name.substring(0, name.indexOf('_'));
            return key;
        };

        var readableName = function (name) {
            var key = getKeyFromName(name);
            var time = name.substring(name.indexOf('_') + 1);
            var hours = time.substring(0, 2);
            var min = time.substring(2, 4);
            var sec = time.substring(4);

            var comp = findCompositeByKey(key);
            var desc = comp.name;

            return (key + " @ " + hours + ":" + min + ":" + sec + (desc !== undefined ? "<br><small>" + desc + "</small>" : ""));
        };

        var expandCollapse = function (id) {
// 	console.log('>> Exp/Coll ' + id);
            var elmt = document.getElementById(id);
            if (elmt.style.display === "none") {
                elmt.style.display = "block";
            } else {
                elmt.style.display = "none";
            }
        };

        /*
          Sample data:

          {
          "2017": {
              "12": {
                  "10": [
                      {
                          "name": "ATL-0001_184206",
                          "compositeElements": [
                              {
                                  "type": "FAX",
                                  "name": "_ATL-0001_0.png",
                                  "resource": "file:/Users/olediour/repos/raspberry-coffee/RESTNavServer/web/2017/12/10/ATL-0001_184206/_ATL-0001_0.png"
                              },
                              {
                                  "type": "FAX",
                                  "name": "_ATL-0001_1.png",
                                  "resource": "file:/Users/olediour/repos/raspberry-coffee/RESTNavServer/web/2017/12/10/ATL-0001_184206/_ATL-0001_1.png"
                              },
                              {
                                  "type": "GRIB",
                                  "name": "grib.grb",
                                  "resource": "file:/Users/olediour/repos/raspberry-coffee/RESTNavServer/web/2017/12/10/ATL-0001_184206/grib.grb"
                              }
                          ]
                      },
                      {
                          "name": "PAC-0001_073637",
                          "compositeElements": [
                              {
                      ...

           */

        var sortObject = function (o) { // Sort by property of level 1
            var sorted = {},
                key, a = [];

            for (key in o) {
                if (o.hasOwnProperty(key)) {
                    a.push(key);
                }
            }

            a.sort();

            for (key = 0; key < a.length; key++) {
                sorted[a[key]] = o[a[key]];
            }
            return sorted;
        };

        var dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

        var makeCompositeTree = function (tree) {
            var htmlCode = "<b>Existing Composites:</b><ul style='margin-left: -20px;'>";
            for (var year in tree) {
                htmlCode += "<li type='disc'>";
                htmlCode += ("<span class='compositeNode' onclick='expandCollapse(\"" + year + "\");' style='cursor: pointer;'>");
                var months = tree[year];
                var nbMonths = Object.keys(months).length;
                htmlCode += (year + " (" + nbMonths + " month" + (nbMonths > 1 ? "s" : "") + ") :");
                htmlCode += ("</span>");
                htmlCode += ("<ul id='" + year + "' style='display: none; padding-left: 10px;'>");
                for (var month in months) {
                    htmlCode += "<li type='disc'>";
                    htmlCode += ("<span class='compositeNode' onclick='expandCollapse(\"" + year + "-" + month + "\");' style='cursor: pointer;'>");
                    var days = sortObject(months[month]);
                    var nbDays = Object.keys(days).length;
                    htmlCode += (monthNames[parseInt(month) - 1] + " (" + nbDays + " day" + (nbDays > 1 ? "s" : "") + ") :");
                    htmlCode += ("</span>");
                    htmlCode += ("<ul id='" + year + "-" + month + "' style='display: none; padding-left: 10px;'>");

                    var sortedDays = Object.keys(days);
                    sortedDays.sort();
                    for (var x = 0; x < sortedDays.length; x++) {
                        var day = sortedDays[x]; // day number as a String
                        // Find week day
                        var date = new Date(year, month - 1, day);
                        var weekDay = date.getDay();
                        htmlCode += "<li type='disc'>";
                        htmlCode += ("<span class='compositeNode' onclick='expandCollapse(\"" + year + "-" + month + "-" + day + "\");' style='cursor: pointer;'>");
                        var compositeList = days[day]; // Array
                        htmlCode += (day + ", " + dayNames[weekDay] + " (" + compositeList.length + " composite" + (compositeList.length > 1 ? "s" : "") + ") :");
                        htmlCode += ("</span>");
                        htmlCode += ("<ul id='" + year + "-" + month + "-" + day + "' style='display: none; padding-left: 10px;'>");
                        for (var i = 0; i < compositeList.length; i++) {
                            var comp = compositeList[i];
                            htmlCode += ("<li type='disc'><a class='compositeNode' onclick='reload(\"" + getKeyFromName(comp.name) + "\", " + JSON.stringify(comp.compositeElements) + ");'>" + readableName(comp.name) + "</a></li>"); // The leaf!
                        }
                        htmlCode += "</ul>";
                        htmlCode += "</li>";
                    }
                    htmlCode += "</ul>";
                    htmlCode += "</li>";
                }
                htmlCode += "</ul>";
                htmlCode += "</li>";
            }
            htmlCode += "</ul>";
            return htmlCode;
        };

        var getCompositeList = function () {
            var filter = document.getElementById("comp-name-filter").value;
//  console.log("Filtering: " + filter);
            var cb = function (value) {
//		console.log(value);
                var data = JSON.parse(value);
                $("#composite-list").html(makeCompositeTree(data)); // "<pre>" + JSON.stringify(data, null, 2) + "</pre>");
            };
            getExistingComposites(cb, filter);
        };

        var displaySummary = function (bestRoute) {
            bestRoute.waypoints.forEach(wp => {
                console.log("At", wp.datetime, "Position", wp.position.latitude, wp.position.longitude);
                console.log("  TWS", wp.tws, "TWD", wp.twd, "BSP", wp.bsp, "HDG", wp.hdg);
            });
        };

        var DURATION_FMT = "Y-m-dTH:i:s";

        var testRouting = function () {

            console.log('GRIB Data:', gribFileLocation); // Use this one?

            if (gribFileLocation === undefined) {
                alert("No GRIB File location, aborting");
                return;
            }
            var toL = (document.getElementById('routing-pos-lat-sign-01').value === 'S' ? -1 : 1) * (parseInt(document.getElementById('routing-pos-lat-deg-01').value) +
                (parseFloat(parseInt(document.getElementById('routing-pos-lat-min-01').value) / 60)));
            var toG = (document.getElementById('routing-pos-lng-sign-01').value === 'W' ? -1 : 1) * (parseInt(document.getElementById('routing-pos-lng-deg-01').value) +
                (parseFloat(parseInt(document.getElementById('routing-pos-lng-min-01').value) / 60)));
            var now = new Date();
            var utc = new Date(now.getTime() + (now.getTimezoneOffset() * 60 * 1000)).format(DURATION_FMT);
            var sampleRequest = {
                "fromL": position.lat,
                "fromG": position.lng,
                "toL": toL,
                "toG": toG,
                "startTime": utc,
                "gribName": gribFileLocation + "/grib.grb",
                "polarFile": "./sample.data/polars/CheoyLee42.polar-coeff",
                "outputType": "JSON",
                "timeInterval": 24,    // Watch the OutOfMemoryError...
                "routingForkWidth": 140,
                "routingStep": 10,
                "limitTWS": -1,
                "limitTWA": -1,
                "speedCoeff": 0.75,
                "proximity": 25,
                "avoidLand": false,
                "verbose": false
            };
            var callback = function (bestRoute) {
                // console.log(bestRoute);
                bestRouteToPlot = JSON.parse(bestRoute); // in grib.routing.js
                displaySummary(bestRouteToPlot);
                plotBestRoute(canvas, context);
            };
            getBestRoute(sampleRequest, callback);
        };

        var compositeInterval;
        var timerInterval;
        var timeToNextLoad = 0;

        var intervalInSeconds = 3600 * 6;

        var secToHMS = function (nbSec) {
            var h = Math.floor(nbSec / 3600);
            var m = Math.floor((nbSec - (h * 3600)) / 60);
            var s = nbSec % 60;

            var strH = h.toFixed(0);
            while (strH.length < 2) {
                strH = '0' + strH;
            }
            var strM = m.toFixed(0);
            while (strM.length < 2) {
                strM = '0' + strM;
            }
            var strS = s.toFixed(0);
            while (strS.length < 2) {
                strS = '0' + strS;
            }
            return strH + ":" + strM + ":" + strS;
        };

        var continuousLoad = function (cb) {
            if (cb.checked === true) { // Start
                timeToNextLoad = intervalInSeconds; // In seconds
                $("#load-composites").prop("disabled", true);
                compositeInterval = setInterval(function () {
                    loadComposite();
                    timeToNextLoad = intervalInSeconds; // In seconds
                }, 1000 * intervalInSeconds); // Every 6 hours
                timerInterval = setInterval(function () {
                        timeToNextLoad -= 1; // Decrease
                        var strTime = secToHMS(timeToNextLoad);
                        $("#time-to-next").text(" (in " + strTime + ")");
                    },
                    1000); // Every second
            } else { // Stop
                $("#load-composites").prop("disabled", false);
                clearInterval(compositeInterval);
                clearInterval(timerInterval);
                $("#time-to-next").text("");
            }
        };

        /**
         * If existing data is provided, it comes from the file system
         */
        var loadComposite = function (existingData) {
            var key = document.getElementById('composites').value;

            var compositeData = (existingData === undefined ? findCompositeByKey(key) : existingData);

            // Clear previous one if any
            gribData = undefined;

            gribFileLocation = undefined;
            if (existingData !== undefined && existingData.gribRequest !== undefined) {
                gribFileLocation = existingData.gribRequest;
                if (gribFileLocation.endsWith("grib.grb")) {
                    gribFileLocation = gribFileLocation.substring(0, gribFileLocation.length - "grib.grb".length);
                }
                if (gribFileLocation.startsWith("file:")) {
                    gribFileLocation = gribFileLocation.substring("file:".length);
                }
                document.getElementById('current-grib-location').innerText = ('GRIB in ' + gribFileLocation);
            }
            // console.log("Loading", (typeof(compositeData) === 'object' ? JSON.stringify(compositeData) : compositeData));
            messageManager("Loading " + (typeof(compositeData) === 'object' ? JSON.stringify(compositeData) : compositeData));
            worldMap.setCanvasWidth(compositeData.canvas.w);
            worldMap.setCanvasHeight(compositeData.canvas.h);
            worldMap.setNorth(compositeData.map.north);
            worldMap.setSouth(compositeData.map.south);
            worldMap.setWest(compositeData.map.west);
            worldMap.setEast(compositeData.map.east); // Recalculated, anyway.
            worldMap.setProjection(compositeData.map.projection);

            worldMap.drawWorldMap();
            $("#grib-checkbox").prop("disabled", true);
            $("#grib-checkbox").prop("checked", false);

            // $("#fax-checkbox").prop("disabled", true);
            // $("#fax-checkbox").prop("checked", false);

            // Clean up dynamic data
            // 1 - Fax Table rows
            var idx = 1;
            var go = true;
            while (go) {
                var row = document.getElementById('row-' + idx);
                if (row !== null) {
                    row.parentNode.removeChild(row);
                    idx += 1;
                } else {
                    go = false;
                }
            }
            // 2 - Fax zooms
            idx = 1;
            go = true;
            while (go) {
                var radio = document.getElementById('zoomfor-' + idx);
                if (radio !== null) {
                    radio.parentNode.removeChild(radio);
                    idx += 1;
                } else {
                    go = false;
                }
            }

            var year, month, day, time;
            var now = new Date();
            year = now.format('Y');
            month = now.format('m');
            day = now.format('d');
            time = compositeData.key + '_' + now.format('His');

            var requestData = [];
            if (compositeData.faxData !== undefined) {

                compositeData.faxData.forEach(function (fax, idx) {
                    var oneFax = {
                        url: fax.faxUrl,
                        name: fax.name,
                        storage: 'web/' + year + '/' + month + '/' + day + '/' + time + '/' + compositeData.key + '_' + idx + '.png', // Original. With the date
                        returned: 'web/' + year + '/' + month + '/' + day + '/' + time + '/_' + compositeData.key + '_' + idx + '.png', // Transformed
                        transparent: fax.transp,
                        imgType: "png",
                        tx: fax.effect
                    };
                    if (fax.tx !== undefined) {
                        oneFax.from = fax.tx.from;
                        oneFax.to = fax.tx.to;
                    }
                    if (fax.rotation !== undefined) {
                        oneFax.rotation = fax.rotation;
                    }
                    requestData.push(oneFax);

                    /*
                      Adding rows like
                    <tr>
                      <td>[checkbox]</td>
                                <td>1</td>
                                <td><div id="name-1"></div></td>
                      <td><div id="x-1" style="text-align: right;"></div></td>
                                <td><div id="y-1" style="text-align: right;"></div></td>
                                <td><div id="zoom-1" style="text-align: right;"></div></td>
                            </tr>
                    */
                    var faxTable = document.getElementById('fax-table');
                    var row = document.createElement('tr');
                    row.id = 'row-' + (idx + 1);

                    // Adding a checkbox <input type="checkbox" onchange="showHide(1, this);" checked>Show fax #1 <br/>
                    var div = document.createElement('div');
                    div.id = 'cb-' + (idx + 1);

                    var cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.id = 'cb-' + (idx + 1);
                    cb.setAttribute('onchange', 'showHide(' + (idx + 1) + ', this);');
                    cb.checked = true;
                    div.appendChild(cb);
                    var col0 = document.createElement('td');
                    col0.setAttribute('style', 'text-align: center;');
                    row.appendChild(col0);
                    col0.appendChild(cb);

                    var col1 = document.createElement('td');
                    row.appendChild(col1);
                    col1.appendChild(document.createTextNode((idx + 1)));

                    var col2 = document.createElement('td');
                    row.appendChild(col2);
                    var div2 = document.createElement('div');
                    div2.id = 'name-' + (idx + 1);
                    div2.style.whiteSpace = "nowrap";
                    div2.appendChild(document.createTextNode(fax.name));
                    col2.appendChild(div2);

                    var col3 = document.createElement('td');
                    row.appendChild(col3);
                    var div3 = document.createElement('div');
                    div3.id = 'x-' + (idx + 1);
                    div3.setAttribute('style', 'text-align: right;');
                    div3.appendChild(document.createTextNode(fax.location.x));
                    col3.appendChild(div3);

                    var col4 = document.createElement('td');
                    row.appendChild(col4);
                    var div4 = document.createElement('div');
                    div4.id = 'y-' + (idx + 1);
                    div4.setAttribute('style', 'text-align: right;');
                    div4.appendChild(document.createTextNode(fax.location.y));
                    col4.appendChild(div4);

                    var col5 = document.createElement('td');
                    row.appendChild(col5);
                    var div5 = document.createElement('div');
                    div5.id = 'zoom-' + (idx + 1);
                    div5.setAttribute('style', 'text-align: left;');
                    div5.appendChild(document.createTextNode(fax.zoom));
                    col5.appendChild(div5);

                    faxTable.appendChild(row);

                }); // end forEach

                // Request ready
                // console.log(requestData);
                messageManager(typeof(requestData) === 'object' ? JSON.stringify(requestData) : requestData);
                getCompositeFaxes(requestData, compositeData, faxRequestCallback);
            }

            if (compositeData.gribRequest !== undefined) {
                makeGRIBRequest(compositeData.gribRequest, existingData === undefined ? 'web/' + year + '/' + month + '/' + day + '/' + time : undefined); // grib file Location
            }
        };

        var speakUp = function (num) {
            document.getElementById("name-" + num).innerText = faxName[num - 1];
            document.getElementById("x-" + num).innerText = (topLeft[num - 1][0] * thisZoomFactor).toFixed(0);
            document.getElementById("y-" + num).innerText = (topLeft[num - 1][1] * thisZoomFactor).toFixed(0);
            document.getElementById("zoom-" + num).innerText = (zoom[num - 1] * thisZoomFactor);
        };

        var zoomFax = function (num, factor) {
            zoom[num - 1] *= factor;
            speakUp(num);
            redraw();
        };

        var zoomIn = function () {
            var factor = parseFloat(document.getElementById("zoom-factor").value);
            zoomFax(currentFax, factor);
        };

        var zoomOut = function () {
            var factor = parseFloat(document.getElementById("zoom-factor").value);
            zoomFax(currentFax, 1 / factor);
        };

        var up = function () {
            topLeft[currentFax - 1][1] -= 1;
            speakUp(currentFax);
            redraw();
        };

        var down = function () {
            topLeft[currentFax - 1][1] += 1;
            speakUp(currentFax);
            redraw();
        };

        var left = function () {
            topLeft[currentFax - 1][0] -= 1;
            speakUp(currentFax);
            redraw();
        };

        var right = function () {
            topLeft[currentFax - 1][0] += 1;
            speakUp(currentFax);
            redraw();
        };

        var showHide = function (num, cb) {
            show[num - 1] = cb.checked;
            redraw();
        };

        let scrollGribInterval = -1;

        function scrollGribs(cb) {
            // console.log("Yes! %s", cb.checked);
            let gribDatesList = document.getElementById("grib-dates");
            if (cb.checked) {
                scrollGribInterval = window.setInterval(() => {
                    // Move to next grib date
                    let selectedIndex = gribDatesList.options.selectedIndex;
                    selectedIndex += 1;
                    if (selectedIndex > gribDatesList.options.length - 1) {
                        selectedIndex = 0;
                    }
                    gribDatesList.options.selectedIndex = selectedIndex;
                    // Redraw
                    redraw();
                }, 2000);
            } else {
                window.clearInterval(scrollGribInterval);
            }
        }

        var redraw = function () {
            worldMap.clear();
//  worldMap.setPositionLabel("");

            if (withChart) { // Chart (and GRIBs) *under* the faxes
                worldMap.drawWorldMap(false);
            }

            for (let sh = 0; sh < show.length; sh++) {
                if (show[sh] === true && faxObj[sh] !== undefined) {
                    context.drawImage(
                        faxObj[sh],
                        topLeft[sh][0] * thisZoomFactor,
                        topLeft[sh][1] * thisZoomFactor,
                        (parseInt(faxObj[sh].width) * zoom[sh]) * thisZoomFactor,
                        (parseInt(faxObj[sh].height) * zoom[sh] * thisZoomFactor)
                    );
                }
            }
//		if (withChart) { // GRIB over the faxes
//			worldMap.drawWorldMap(false);
//		}
        };

        var changeFax = function (val) {
            currentFax = val;
        };

        const GRIB_DEBUG = false;

        var plotGrib = function (jsonGrib) {
            if (GRIB_DEBUG) { // DEBUG
                // console.log("Received GRIB");
                messageManager("Received GRIB");
                // Extract the dates
                jsonGrib.forEach((grib, idx) => {
                    // console.log('GRIB Date:', grib.gribDate.formattedUTCDate);
                    messageManager('GRIB Date:' + grib.gribDate.formattedUTCDate);
                });

                jsonGrib[0].typedData.forEach((type, idx) => {
                    // console.log('Type:', type.gribType.desc);
                    messageManager('Type:' + type.gribType.desc);
                });
            }
            // Create the UI widgets to deal with the GRIB
            // 1. Dates
            var gribDates = $("#grib-dates");
            gribDates
                .find('option')
                .remove();

            jsonGrib.forEach((grib, idx) => {
                gribDates.append($('<option>', {
                    value: grib.gribDate.formattedUTCDate,
                    text: grib.gribDate.formattedUTCDate
                }));
            });
            // 2. Types
            var gribTypes = $("#grib-types");
            gribTypes
                .find('option')
                .remove();

            var foundWind = false;
            jsonGrib[0].typedData.forEach((type, idx) => {
                if (type.gribType.type === 'vgrd' || type.gribType.type === 'ugrd') {
                    if (!foundWind) {
                        gribTypes.append($('<option>', {
                            value: 'wind',
                            text: 'Surface Wind',
                            selected: 'selected'
                        }));
                    }
                    foundWind = true;
                } else {
                    gribTypes.append($('<option>', {
                        value: type.gribType.type,
                        text: type.gribType.desc
                    }));
                }
            });

            gribData = jsonGrib; // gribData is a function prm
            // Min and max for each grib data
            findMinMax(gribData, 0);

            redraw();
        };

        function findMinMax(gribData, idx) { // TODO Call this when GRIB date changes
            // console.log("Display min and max for index", idx);
            messageManager("Display min and max for index:" + idx);
            let gribObj = gribData[idx];
            console.log(gribObj.gribDate.formattedUTCDate);
            for (let i = 0; i < gribObj.typedData.length; i++) {
                let gribTypeData = gribObj.typedData[i];
                if (gribTypeData.gribType.type !== 'vgrd' && gribTypeData.gribType.type !== 'ugrd') {
                    console.log("Type %s (%s), min=%f, max=%f", gribTypeData.gribType.desc, gribTypeData.gribType.type, gribTypeData.gribType.min, gribTypeData.gribType.max);
                    switch (gribTypeData.gribType.type) {
                        case 'tmp':
                            try {
                                document.getElementById('min-max-atemp').innerText = `Air Temp: min ${(gribTypeData.gribType.min - 273).toFixed(2)}\xB0C, max ${(gribTypeData.gribType.max - 273).toFixed(2)}\xB0C`;
                            } catch (err) {
                            }
                            break;
                        case 'htsgw':
                            try {
                                document.getElementById('max-waves').innerText = `Waves: max ${(gribTypeData.gribType.max).toFixed(2)} m`;
                            } catch (err) {
                            }
                            break;
                        case 'prate':
                            try {
                                document.getElementById('max-prate').innerText = `P-Rate: max ${(3600 * gribTypeData.gribType.max).toFixed(2)} mm/h`;
                            } catch (err) {
                            }
                            break;
                        default:
                            break;
                    }
                }
            }
        }

        let displayCompositeInfo = function () {
            console.log('Displaying');
            let infoDiv = document.getElementById('composite-info');
            let compositeId = document.getElementById('composites').value;
            let content = "<h1>Not found</h1>";
            for (let i = 0; i < compositeCatalog.length; i++) {
                if (compositeCatalog[i].key === compositeId) {
                    content = "<h3>" + compositeCatalog[i].name + "</h3>";
                    content += "<ul>";
                    if (compositeCatalog[i].gribRequest !== undefined) {
                        content += ("<li>" + compositeCatalog[i].gribRequest + "</li>");
                    }
                    if (compositeCatalog[i].faxData !== undefined) {
                        compositeCatalog[i].faxData.forEach(fax => {
                            content += ("<li>" + fax.name + "</li>");
                        });
                    }
                    content += "</ul>";
                    break;
                }
            }

            infoDiv.innerHTML = content;
        };

        let hideCompositeInfo = function () {
            console.log('Hiding');
            let infoDiv = document.getElementById('composite-info');
            infoDiv.innerHTML = "";
        };

        var makeGRIBRequest = function (gribRequest, where) {
            var rawRequest = gribRequest;
            if (rawRequest === undefined) {
                rawRequest = $("#grib-request").val();
            }
            console.log(rawRequest);
            var jsonRequest = {request: rawRequest};
            if (where !== undefined) {
                console.log('... into', where);
                jsonRequest.directory = where;
                gribFileLocation = where; // Used for routing. Directory of grib.grb
                document.getElementById('current-grib-location').innerText = ('GRIB in ' + gribFileLocation);
            }
            worldMap.setAfterDrawing(renderGRIBData); // That is the callback

            requestGRIB(jsonRequest, plotGrib);
        };

        var renderGRIB = function () {
            var rawGrib = JSON.parse($("#json-grib").val());
            worldMap.setAfterDrawing(renderGRIBData);
            plotGrib(rawGrib);
        };

        var flipGRIB = function (radio) {
            if (radio.value === 'web') {
                $("#grib-web").css('display', 'block');
                $("#grib-json").css('display', 'none');
            } else if (radio.value === 'json') {
                $("#grib-web").css('display', 'none');
                $("#grib-json").css('display', 'block');
            }
        };

        var updateGRIBRequest = function (option) {
            var key = option.value;
            for (var i = 0; i < compositeCatalog.length; i++) {
                if (key === compositeCatalog[i].key) {
                    if (compositeCatalog[i].gribRequest !== undefined) {
                        $("#grib-request").val(compositeCatalog[i].gribRequest);
                    } else {
                        $("#grib-request").val('');
                    }
                    break;
                }
            }
        };

        var changeCanvasSize = function (factor) {
            thisZoomFactor *= factor;
            worldMap.setCanvasHeight(worldMap.getCanvasHeight() * factor);
            worldMap.setCanvasWidth(worldMap.getCanvasWidth() * factor);
            // Faxes offset and zoom
            for (var sh = 0; sh < show.length; sh++) {
                speakUp(sh + 1);
            }
            redraw();
        };

    </script>
    <style>
        .map-style {
            display: block;
            height: 400px; /* Overridden onload */
            width: 850px;
            resize: both; /* Resize! */
            overflow-x: auto;
            overflow-y: auto;
            text-align: center;
        }

        .table-style {
            padding: 5px;
            background: #fff;
            border-radius: 5px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #CCC;
            margin-top: 10px;
        }

        .complist-style {
            padding: 5px;
            background: #fff;
            border-radius: 5px;
            height: 100px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #CCC;
            margin-top: 10px;
        }

        button {
            border-radius: 5px;
        }
    </style>
</head>
<body style="background-color: rgba(255, 255, 255, 0.2); background-image: none;">
<h2>Weather Wizard in HTML5 - Operations <span id="time-to-next"></span></h2>
<div>
    <table border="0">
        <tr>
            <td valign="top" rowspan="2">
                <div id="map-container" class="map-style">
                    <canvas id="mapCanvas" width="1400" height="900"></canvas>
                </div>
            </td>
            <td valign="top">
                <!--div style="max-width: 350px; height: 600px; resize: both; overflow-x: scroll; overflow-y: scroll;"-->
                <div style="width: 350px; height: 600px; resize: both; overflow-x: scroll; overflow-y: scroll;">
                    <input type="checkbox" onchange="changeChart(this);" checked/> With Chart&nbsp;
                    <input type="checkbox" onchange="changeGrid(this);" checked/> With Grid&nbsp;
                    <input type="checkbox" onchange="changeTropics(this);"/> With Tropics
                    <br/>
                    <input id="grib-checkbox" type="checkbox" onchange="changeGRIB(this);" disabled/> With GRIB Data
                    <input id="fax-checkbox" type="checkbox" onchange="changeFAXES(this);" checked/> With Faxes
                    <hr/>
                    <select id="composites" onchange="updateGRIBRequest(this);" onmouseover="displayCompositeInfo();"
                            onmouseleave="hideCompositeInfo();"></select> <!-- TODO Composite Info on mouse over -->
                    <button id="load-composites" onclick="loadComposite();">Load documents</button>

                    <input type="checkbox" onchange="continuousLoad(this);"/>Every 6 hours
                    <hr/>
                    <input type="radio" name="grib-origin" value="web" checked onchange="flipGRIB(this);">From the Web
                    <input type="radio" name="grib-origin" value="json" onchange="flipGRIB(this);">From Server Storage
                    <hr/>
                    <div id="grib-web">
                    </div>
                    <div id="grib-json" style="display: none;">
                        <button onclick="getCompositeList();">Get Composites list</button>
                        <input type="text" id="comp-name-filter" placeholder="Composite Name Filter"
                               title="Enter the Composite key, or any part of the name of the directory the composite lives in."/>
                        <div id="composite-list" class="complist-style"></div>
                    </div>
                    <hr/>
                    Zoom for the whole thing:
                    <button onclick="changeCanvasSize(0.9);">-</button>
                    <button onclick="changeCanvasSize(1.1);">+</button>
                    <hr/>
                    <div class="table-style">
                        <table>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                            </tr>
                            <tr>
                                <td>
                                    <select id="grib-dates" onchange="redraw()"></select>
                                </td>
                                <td>
                                    <select id="grib-types" onchange="redraw()"></select>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2"><input type="checkbox" onchange="scrollGribs(this);">Scroll through
                                    dates
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div id="dyn-faxes" class="table-style">
                        <!--span>Show faxes checkbox (TODO)</span-->
                        <table id="fax-table">
                            <tr>
                                <th>Show</th>
                                <th>#</th>
                                <th>Name</th>
                                <th>x</th>
                                <th>y</th>
                                <th>zoom</th>
                            </tr>
                        </table>
                    </div>
                    <div id="min-max-data" class="table-style">
                        <div id="max-wind"></div>
                        <div id="min-max-atemp"></div>
                        <div id="max-waves"></div>
                        <div id="max-prate"></div>
                    </div>
                    <!-- TODO Analog displays for the values -->
                    <div id="mouse-data" class="table-style"></div>
                    <div id="composite-info"></div>
                </div>
            </td>
        </tr>
        <tr>
            <td colspan="2">
                <div id="err-mess"></div>
            </td>
        </tr>
    </table>
</div>

<!-- For tests, only -->
<div>
    Click on map sets:
    <input type="radio" name="from-to" value="position" id="rb-position" checked>Start from (position)
    <input type="radio" name="from-to" value="going-to" id="rb-going-to">Going to
</div>
Going to: Latitude:
<select id="routing-pos-lat-sign-01">
    <option value="N" selected>N</option>
    <option value="S">S</option>
</select>
<input type="number"
       id="routing-pos-lat-deg-01"
       placeholder="Deg"
       title="Lat degrees to set"
       style="width: 40px; text-align: center;"
       min="0"
       max="90"
       step="1"
       value="0"/>
<input type="number"
       id="routing-pos-lat-min-01"
       placeholder="Minutes"
       title="Lat minutes to set"
       style="width: 60px; text-align: center;"
       min="0"
       max="59.99"
       step="0.01"
       value="00.00"/>
&nbsp;&nbsp;Longitude:
<select id="routing-pos-lng-sign-01">
    <option value="E" selected>E</option>
    <option value="W">W</option>
</select>
<input type="number"
       id="routing-pos-lng-deg-01"
       placeholder="Deg"
       title="Lng degrees to set"
       style="width: 40px; text-align: center;"
       min="0"
       max="180"
       step="1"
       value="0"/>
<input type="number"
       id="routing-pos-lng-min-01"
       placeholder="Minutes"
       title="Lng minutes to set"
       style="width: 60px; text-align: center;"
       min="0"
       max="59.99"
       step="0.01"
       value="00.00"/>
<button onclick="testRouting();" title="Early test, no UI" style="color: red;">Routing <b>Test</b></button>
<div style="min-height: 16px;">
    <span id="current-grib-location"></span>
</div>
<!-- End of Test -->
<table width="100%" cellpadding="0" cellspacing="0" border="0"> <!--  style="position: fixed; bottom: 0;" -->
    <tr>
        <td align="left" valign="top" height="40">
            <address><span id="console-type"></span></address>
        </td>
    </tr>
    <tr>
        <td>
            <!-- Messages -->
            <div id="message-zone" style="padding: 1px; border-radius: 5px; border: 1px solid #CCC; min-height: 50px; max-height: 100px; overflow-y: scroll;"></div>
            <button onclick="clearMessZone();">Clear</button>
        </td>
    </tr>
</table>
</body>
</html>
